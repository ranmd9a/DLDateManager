# DLDateManager

## 概要
- BeatSaber でダウンロードしたカスタム譜面のダウンロード日時を保存・復元するためのツールです。
  - BetterSongList や [beatlist](https://github.com/ranmd9a/beatlist/releases/latest) ではカスタム譜面の info.dat の「作成日時」をダウンロード日時として利用しています。  
    なので、例えば以下のようなことをすると、ダウンロード日時が変わってしまいます。
    - CustomLevels フォルダを C: ドライブに置いていたが、空き容量が減ってきたので D: ドライブに移動した
    - まちがって CustomLevels フォルダを消してしまったので、バックアップから戻して上書きした、またはダウンロードしなおした
  - このツールで事前にダウンロード日時を保存しておき、上記の作業を行ったあとに復元すれば、ダウンロード日時を元の状態に戻すことができます。
  - **(念のため)このツールで保存しておいた日時に戻すことができるだけなので誤解なきよう。このツールを使う前にすでに変わってしまったダウンロード日時は元に戻せません。**
- バグがあるかもしれないので、使用前に適宜バックアップをお願いいたします。

## インストール手順
1. .NET 6.0 Runtime が必要なので、事前に以下の「デスクトップアプリを実行する」から「x64」のランタイムをダウンロードしてインストールしておいてください。  
   https://dotnet.microsoft.com/ja-jp/download/dotnet/6.0/runtime
   - このツールはとりあえず 64bit版(x64) のみ対象としています。
2. [Release ページ](https://github.com/ranmd9a/DLDateManager/releases/latest)から最新の DLDateManager_x64_v0.0.x.zip をダウンロードして、任意のディレクトリに展開してください。

## アンインストール手順
1. 上記で展開したディレクトリごと削除してください。  
  ※必要なければ `backup_*.clist` ファイルも。

## 使い方

### ◆ダウンロード日時の保存手順
1. 「インストール手順」で展開したディレクトリの DLDateManager.exe をダブルクリックして実行します。
2. [情報保存]ボタンを押してください。
      <p>
        <img src="https://github.com/ranmd9a/DLDateManager/wiki/images/mainpage.png" alt="mainpage" width="75%"/>
      </p>

3. [CustomLevels フォルダを指定してください。]という画面が表示されます。
   - 既定で BeatSaber インストールフォルダの下の `\Beat Saber_Data\CustomLevels` が選択されているはずです。
   - 選択されていない場合、または別のフォルダにしたい場合はフォルダアイコンをクリックして選択してください。
     <p>
       <img src="https://github.com/ranmd9a/DLDateManager/wiki/images/save001.png" alt="save001" width="75%"/>
     </p>

4. [次へ]ボタンを押してください。
5. 指定したフォルダにあるカスタム譜面の情報の読み込みが開始されます。
6. 「xx 件取得しました。[保存して閉じる]ボタンを押して保存してください。」という文言が表示されたら [重複しているフォルダ]欄、[読み込みに失敗したフォルダ]欄の内容を確認してください。
   - それぞれ何も表示されていなければ問題ありません。
   - CustomLevels フォルダの下に重複しているカスタム譜面がある場合、[重複しているフォルダ]欄にそれが表示されるので、必要に応じて重複を解消して **2. からやり直してください。**  
    ※重複したままでもかまわないなら何もしなくていいです。ただし、[保存して閉じる]で保存したファイルには重複した情報が入った状態になりますので、それをもとに復元＆ダウンロードすると重複状態も復元されます。
   - カスタム譜面の情報を取得できなかったものは [読み込みに失敗したフォルダ]欄に表示されるので、該当フォルダの内容を確認してください。  
    ※info.dat という名前の必須のファイルがない場合などにここに表示されます。

      <p>
        <img src="https://github.com/ranmd9a/DLDateManager/wiki/images/save002.png" alt="save002" width="75%"/>
      </p>

7. [保存して閉じる]ボタンを押して情報を保存してください。
   - 保存せずに終了する場合は右上の×ボタンで閉じてください。
   - 「`backup_20220503-1705.clist`」のような名前でダウンロード日時情報がファイルに保存されるので、適宜保管しておいてください。

### ◆ダウンロード日時の復元手順

- **BeatSaber や beatlist が起動している場合、終了してから実行してください。**

1. 「インストール手順」で展開したフォルダの DLDateManager.exe をダブルクリックして実行します。
2. [情報復元]ボタンを押してください。
3. ファイル選択ダイアログが表示されるので「ダウンロード日時の保存手順」で保存しておいた `backup_*.clist` を選択してください。
4. [復元先の CustomLevels フォルダを指定してください。]という画面が表示されます。
   - 既定で BeatSaber インストールフォルダの下の `\Beat Saber_Data\CustomLevels` フォルダが選択されているはずです。
   - 選択されていない場合、または別のフォルダにしたい場合はフォルダアイコンをクリックして選択してください。
   - フォルダ選択ダイアログでは、安全のため、フォルダ名が `CustomLevels` でない場合、エラーになるようにしています。
      <p>
        <img src="https://github.com/ranmd9a/DLDateManager/wiki/images/restore002.png" alt="restore002" width="75%"/>
      </p>

5. [次へ]ボタンを押してください。
6. [ダウンロード日時の復元を行います。]という画面が表示されるので、表示内容を確認してください。
   - `backup_*.clist` にあるカスタム譜面が復元先に存在しない場合、[復元先に存在しない曲]欄にその数が表示されます。
   - 復元先に存在しない曲をダウンロードしなおしたい場合は[復元先に存在しない曲をダウンロードする]にチェックしてください。
     - ダウンロード機能はおまけなのであまり過信しないでください。ちゃんと CustomLevels フォルダを別途バックアップしておくほうが安全です。
     - beatsaver.com からすでに削除されている曲はダウンロードできません。

      <p>
        <img src="https://github.com/ranmd9a/DLDateManager/wiki/images/restore003.png" alt="restore003" width="75%"/>
      </p>

7. [復元開始]ボタンを押してください。
   - ダウンロード日時の復元処理が開始されます。
8. 処理が無事終わったら[閉じる]ボタンを押して画面を閉じてください。

      <p>
        <img src="https://github.com/ranmd9a/DLDateManager/wiki/images/restore004.png" alt="restore004" width="75%"/>
      </p>



## このツールの処理内容について補足
- 保存時は各カスタム譜面の info.dat の作成日時を `backup_*.clist` に保存しています。
- 復元時は `backup_*.clist` に保存されていた日時を各カスタム譜面のフォルダ(「`1a33 (RELOADED - Saut)`」等)および全ファイル(「`cover.jpg`」、「`info.dat`」等)の作成日時に設定しなおします。
  - その日時にカスタム譜面をダウンロードしたときとなるべく同じ状態になるようにしています。
  - また、SongBrowser はダウンロード日時を以下のように計算しているようなので(違ってたらすいません)、それに対応するため、というのもあります。
    - カバー画像がある場合はカバー画像のファイルの作成日時と更新日時の大きいほう
    - カバー画像がない場合はカスタム譜面のフォルダの作成日時
- 上記のような処理のため、ダウンロードしたあとに info.dat を差し替えたりしているとダウンロード日時が実際にダウンロードした日時からずれる可能性があります。
